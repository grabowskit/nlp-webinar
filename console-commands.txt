# text embedding ingest  pipeline with inference model
PUT _ingest/pipeline/text-embeddings
{
  "description": "Text embedding pipeline",
  "processors": [
    {
      "inference": {
        "model_id": "sentence-transformers__msmarco-minilm-l-12-v3",
        "target_field": "text_embedding",
        "field_map": {
          "body_content_window": "text_field"
        }
      }
    }
  ],
  "on_failure": [
    {
      "set": {
        "description": "Index document to 'failed-<index>'",
        "field": "_index",
        "value": "failed-{{{_index}}}"
      }
    },
    {
      "set": {
        "description": "Set error message",
        "field": "ingest.failure",
        "value": "{{_ingest.on_failure_message}}"
      }
    }
  ]
}

# template mapping for dense vector field 
PUT blogs-with-embeddings
{
  "mappings": {
    "properties": {
      "text_embedding.predicted_value": {
        "type": "dense_vector",
        "dims": 384,
        "index": true,
        "similarity": "cosine"
      }
    }
  }
}

# Reindex to use text embedding pipeline - returns <task_id>
POST _reindex?wait_for_completion=false
{
  "source": {
    "index": "blogs"
  },
  "dest": {
    "index": "blogs-with-embeddings",
    "pipeline": "text-embeddings"
  }
}

POST _ml/trained_models/sentence-transformers__msmarco-minilm-l-12-v3/deployment/_infer
{
  "docs": [{"text_field": "Find anomalies in location data"}]
}

POST blogs-with-embeddings/_knn_search
{
  "_source": ["body_content_window", "url"],
  "knn": {
    "field": "text_embedding.predicted_value",
    "k": 5,
    "num_candidates": 10,
    "query_vector": [
    0.07453683018684387,
    -0.20754237473011017,
    0.09392242133617401,
    -0.168579563498497,
    0.16574659943580627,
    -0.24965845048427582,
    -0.0637546256184578,
    0.15377818048000336,
    0.1970960646867752,
    -0.049272604286670685,
    -0.015231008641421795,
    0.16086797416210175,
    0.5799350738525391,
    -0.28325632214546204,
    0.010942737571895123,
    -0.0740034431219101,
    -0.10300994664430618,
    -0.19055764377117157,
    0.4934651553630829,
    -0.4801654815673828,
    -0.6419429779052734,
    -0.276655375957489,
    0.0678764283657074,
    -0.24390104413032532,
    -0.0996488556265831,
    -0.5017780661582947,
    -0.38430771231651306,
    0.09233365207910538,
    -0.004614796955138445,
    -0.20456059277057648,
    0.32464003562927246,
    0.05074679106473923,
    0.5083959698677063,
    -0.07772758603096008,
    0.5430670380592346,
    -0.06857594847679138,
    0.06315562129020691,
    0.07167576253414154,
    0.26054632663726807,
    0.28618738055229187,
    -0.16787610948085785,
    0.030669301748275757,
    -0.2703286111354828,
    -0.050597984343767166,
    -0.26954373717308044,
    -0.5736544132232666,
    -0.13009706139564514,
    0.5253201723098755,
    -0.10878488421440125,
    0.01802317425608635,
    -0.4904610216617584,
    -0.1387004405260086,
    -0.37050649523735046,
    -0.017917152494192123,
    -0.009257081896066666,
    0.01446389127522707,
    -0.28164637088775635,
    0.2689937949180603,
    0.1061459630727768,
    -0.4629402756690979,
    0.44951868057250977,
    0.04553951323032379,
    -0.30912691354751587,
    -0.11961229890584946,
    0.3650667667388916,
    -0.35222452878952026,
    -0.000201385875698179,
    -0.30415475368499756,
    0.33520442247390747,
    -0.23900730907917023,
    -0.4143907129764557,
    0.3433424234390259,
    -0.18148966133594513,
    0.20333224534988403,
    0.00229476485401392,
    0.09240588545799255,
    -0.17224222421646118,
    0.2306763082742691,
    0.22557112574577332,
    -0.08424504101276398,
    -0.12116168439388275,
    -0.07865840941667557,
    0.2714601457118988,
    -0.019683972001075745,
    0.5623365044593811,
    0.05923556536436081,
    -0.044839732348918915,
    0.22330515086650848,
    -0.22137099504470825,
    -0.2182525098323822,
    -0.07840805500745773,
    -0.11693237721920013,
    -0.008497655391693115,
    -0.08890572935342789,
    -0.15319859981536865,
    0.04097243770956993,
    0.38847601413726807,
    -0.28254497051239014,
    0.8242197036743164,
    0.37031427025794983,
    0.4751337468624115,
    -0.4729408621788025,
    -0.11655991524457932,
    0.2736399471759796,
    0.01433122530579567,
    0.3890840709209442,
    -0.22920817136764526,
    -0.00638661440461874,
    0.41521981358528137,
    0.489855021238327,
    -0.24527794122695923,
    0.13456924259662628,
    -0.30009257793426514,
    0.11374812573194504,
    0.029407544061541557,
    0.22457940876483917,
    0.004723029676824808,
    -0.11029675602912903,
    -0.1222982257604599,
    -0.09819002449512482,
    -0.2638684809207916,
    0.12376802414655685,
    -0.08935405313968658,
    -0.25058940052986145,
    0.17689841985702515,
    -0.0014583005104213953,
    0.05362077057361603,
    0.038721293210983276,
    0.3581225275993347,
    0.19437193870544434,
    -0.032871048897504807,
    -0.06908092647790909,
    0.007740864995867014,
    -0.09648827463388443,
    -0.03692007064819336,
    0.288025438785553,
    0.023409629240632057,
    -0.06219329312443733,
    -0.9594833850860596,
    -0.22430236637592316,
    -0.1480470597743988,
    -0.11456092447042465,
    0.5226597189903259,
    0.1850338578224182,
    0.3367396891117096,
    0.2890723645687103,
    0.18791335821151733,
    0.29053983092308044,
    -0.3728109300136566,
    0.042980924248695374,
    0.15914146602153778,
    0.04038465395569801,
    -0.23090249300003052,
    0.17610734701156616,
    -0.33448532223701477,
    -0.01719403825700283,
    -0.5553179383277893,
    -0.2767239809036255,
    -0.5561366081237793,
    -0.08547887951135635,
    0.13882502913475037,
    0.3474807143211365,
    0.4590737521648407,
    -0.14843913912773132,
    0.39384305477142334,
    -0.08534593135118484,
    -0.01026185229420662,
    0.23120488226413727,
    0.18327820301055908,
    0.24484306573867798,
    -0.17054015398025513,
    -0.03851364180445671,
    0.23073561489582062,
    -0.003950655460357666,
    0.014295939356088638,
    0.20093658566474915,
    0.31966713070869446,
    0.5458610653877258,
    -0.16919992864131927,
    -0.04218471050262451,
    -0.326958566904068,
    -0.38657236099243164,
    -0.18662288784980774,
    0.5816627144813538,
    -0.06113113462924957,
    -0.27536436915397644,
    0.27538156509399414,
    0.017201587557792664,
    0.3405604064464569,
    -0.513244092464447,
    0.3434593975543976,
    -0.5581334829330444,
    0.33396321535110474,
    -0.47166380286216736,
    0.2761699855327606,
    -0.10682584345340729,
    0.1433386206626892,
    0.527672529220581,
    0.20258204638957977,
    0.03596622869372368,
    0.2698138952255249,
    0.23160642385482788,
    -0.25965362787246704,
    -0.16222327947616577,
    -0.21663546562194824,
    -0.012845292687416077,
    0.13349254429340363,
    0.29629626870155334,
    0.01539093442261219,
    -0.015384765341877937,
    -0.2916506230831146,
    -0.05512615665793419,
    -0.3370289206504822,
    -0.06509958952665329,
    -0.19055384397506714,
    -0.12901395559310913,
    -0.029568778350949287,
    0.09933248162269592,
    0.19965331256389618,
    -0.08172080665826797,
    -0.4356915056705475,
    -0.48613160848617554,
    -0.05599459633231163,
    -0.22870254516601562,
    -0.24515070021152496,
    -0.1655881404876709,
    -0.45532453060150146,
    -0.13017819821834564,
    -0.1163177490234375,
    -0.20278531312942505,
    0.12183140218257904,
    0.15735071897506714,
    0.31192952394485474,
    0.6003413796424866,
    -0.16229240596294403,
    0.4107511043548584,
    -0.17133498191833496,
    -0.4438570737838745,
    -0.13358762860298157,
    0.16060805320739746,
    0.016250841319561005,
    0.004633689299225807,
    -0.0009835069067776203,
    0.0770757645368576,
    -0.5164621472358704,
    -0.2723758816719055,
    -0.35769352316856384,
    -0.009371048770844936,
    0.08567501604557037,
    0.45395633578300476,
    -0.018107512965798378,
    -0.5487083196640015,
    -0.17641381919384003,
    0.23114930093288422,
    0.039185669273138046,
    0.11175128072500229,
    -0.09822078794240952,
    0.031710028648376465,
    0.6688704490661621,
    -0.08064703643321991,
    0.23385947942733765,
    -0.49876806139945984,
    -0.1481647789478302,
    -0.1651521474123001,
    0.1581958830356598,
    0.3907588720321655,
    0.19771340489387512,
    0.13824328780174255,
    -0.10861290991306305,
    0.37062060832977295,
    -0.32603806257247925,
    0.652683436870575,
    0.3627920150756836,
    0.07582543790340424,
    -0.09147480130195618,
    0.043183207511901855,
    0.22038915753364563,
    -0.1939820945262909,
    0.022341959178447723,
    0.5047318935394287,
    -0.259931743144989,
    0.18978877365589142,
    0.19424182176589966,
    0.29646649956703186,
    -0.10196372866630554,
    0.22203649580478668,
    -0.5911935567855835,
    0.2748180627822876,
    0.2933439612388611,
    0.13591046631336212,
    -0.18686443567276,
    0.05299588292837143,
    -0.46956178545951843,
    0.1731799691915512,
    0.23355211317539215,
    -0.12852972745895386,
    0.0305658970028162,
    0.01566079817712307,
    -0.1997469812631607,
    -0.478629469871521,
    -0.010015438310801983,
    0.0829777866601944,
    -0.12942516803741455,
    0.25652238726615906,
    -0.5318357944488525,
    0.33982107043266296,
    0.41761672496795654,
    0.36571988463401794,
    0.4389635920524597,
    0.2363681048154831,
    -0.35565608739852905,
    -0.024740615859627724,
    0.03209609538316727,
    -0.22956980764865875,
    -0.11218611150979996,
    0.1492803692817688,
    -0.009255750104784966,
    0.21540944278240204,
    0.08700158447027206,
    -0.32436835765838623,
    0.11313005536794662,
    0.32171618938446045,
    -0.22453978657722473,
    -0.11332181841135025,
    -0.33852827548980713,
    -0.22908449172973633,
    -0.06537609547376633,
    0.42628511786460876,
    0.14143924415111542,
    -0.17935670912265778,
    -0.09369131922721863,
    -0.389884352684021,
    -0.13897141814231873,
    -0.13815243542194366,
    0.1320265233516693,
    0.0790148675441742,
    0.37558579444885254,
    -0.13394588232040405,
    -0.18961599469184875,
    -0.27387189865112305,
    -0.32254835963249207,
    0.2640625834465027,
    -0.2496419996023178,
    -0.22936351597309113,
    0.2660328149795532,
    0.03733725845813751,
    -0.13335749506950378,
    0.6186579465866089,
    0.10268396884202957,
    0.06378074735403061,
    0.1466071456670761,
    -0.309270441532135,
    -0.2465892881155014,
    -0.004508619662374258,
    0.08941607922315598,
    -0.018520325422286987,
    0.11097671836614609,
    0.3348693549633026,
    0.10179654508829117,
    -0.3345291316509247,
    -0.03973673656582832,
    0.06459066271781921,
    0.10482361167669296,
    0.2873627543449402,
    -0.16425643861293793,
    0.3101359009742737,
    -0.2142046093940735,
    -0.11375072598457336,
    0.44356849789619446,
    -0.21818485856056213,
    0.3203272819519043,
    -0.3074287474155426,
    0.20901866257190704,
    -0.02112933248281479,
    -0.2625077962875366,
    -0.0888354480266571,
    0.11917126178741455,
    -0.24305285513401031,
    0.04227721691131592,
    -0.15884175896644592,
    -0.3789592981338501,
    0.32920658588409424,
    -0.3736388385295868,
    0.011763619258999825
  ]
  }
}

GET blogs-with-embeddings/_knn_search
{
  "knn": {
    "field": "text_embedding.predicted_value",
    "k": 5,
    "num_candidates": 10,
    "query_vector": [
    0.07453683018684387,
    -0.20754237473011017,
    0.09392242133617401,
    -0.168579563498497,
    0.16574659943580627,
    -0.24965845048427582,
    -0.0637546256184578,
    0.15377818048000336,
    0.1970960646867752,
    -0.049272604286670685,
    -0.015231008641421795,
    0.16086797416210175,
    0.5799350738525391,
    -0.28325632214546204,
    0.010942737571895123,
    -0.0740034431219101,
    -0.10300994664430618,
    -0.19055764377117157,
    0.4934651553630829,
    -0.4801654815673828,
    -0.6419429779052734,
    -0.276655375957489,
    0.0678764283657074,
    -0.24390104413032532,
    -0.0996488556265831,
    -0.5017780661582947,
    -0.38430771231651306,
    0.09233365207910538,
    -0.004614796955138445,
    -0.20456059277057648,
    0.32464003562927246,
    0.05074679106473923,
    0.5083959698677063,
    -0.07772758603096008,
    0.5430670380592346,
    -0.06857594847679138,
    0.06315562129020691,
    0.07167576253414154,
    0.26054632663726807,
    0.28618738055229187,
    -0.16787610948085785,
    0.030669301748275757,
    -0.2703286111354828,
    -0.050597984343767166,
    -0.26954373717308044,
    -0.5736544132232666,
    -0.13009706139564514,
    0.5253201723098755,
    -0.10878488421440125,
    0.01802317425608635,
    -0.4904610216617584,
    -0.1387004405260086,
    -0.37050649523735046,
    -0.017917152494192123,
    -0.009257081896066666,
    0.01446389127522707,
    -0.28164637088775635,
    0.2689937949180603,
    0.1061459630727768,
    -0.4629402756690979,
    0.44951868057250977,
    0.04553951323032379,
    -0.30912691354751587,
    -0.11961229890584946,
    0.3650667667388916,
    -0.35222452878952026,
    -0.000201385875698179,
    -0.30415475368499756,
    0.33520442247390747,
    -0.23900730907917023,
    -0.4143907129764557,
    0.3433424234390259,
    -0.18148966133594513,
    0.20333224534988403,
    0.00229476485401392,
    0.09240588545799255,
    -0.17224222421646118,
    0.2306763082742691,
    0.22557112574577332,
    -0.08424504101276398,
    -0.12116168439388275,
    -0.07865840941667557,
    0.2714601457118988,
    -0.019683972001075745,
    0.5623365044593811,
    0.05923556536436081,
    -0.044839732348918915,
    0.22330515086650848,
    -0.22137099504470825,
    -0.2182525098323822,
    -0.07840805500745773,
    -0.11693237721920013,
    -0.008497655391693115,
    -0.08890572935342789,
    -0.15319859981536865,
    0.04097243770956993,
    0.38847601413726807,
    -0.28254497051239014,
    0.8242197036743164,
    0.37031427025794983,
    0.4751337468624115,
    -0.4729408621788025,
    -0.11655991524457932,
    0.2736399471759796,
    0.01433122530579567,
    0.3890840709209442,
    -0.22920817136764526,
    -0.00638661440461874,
    0.41521981358528137,
    0.489855021238327,
    -0.24527794122695923,
    0.13456924259662628,
    -0.30009257793426514,
    0.11374812573194504,
    0.029407544061541557,
    0.22457940876483917,
    0.004723029676824808,
    -0.11029675602912903,
    -0.1222982257604599,
    -0.09819002449512482,
    -0.2638684809207916,
    0.12376802414655685,
    -0.08935405313968658,
    -0.25058940052986145,
    0.17689841985702515,
    -0.0014583005104213953,
    0.05362077057361603,
    0.038721293210983276,
    0.3581225275993347,
    0.19437193870544434,
    -0.032871048897504807,
    -0.06908092647790909,
    0.007740864995867014,
    -0.09648827463388443,
    -0.03692007064819336,
    0.288025438785553,
    0.023409629240632057,
    -0.06219329312443733,
    -0.9594833850860596,
    -0.22430236637592316,
    -0.1480470597743988,
    -0.11456092447042465,
    0.5226597189903259,
    0.1850338578224182,
    0.3367396891117096,
    0.2890723645687103,
    0.18791335821151733,
    0.29053983092308044,
    -0.3728109300136566,
    0.042980924248695374,
    0.15914146602153778,
    0.04038465395569801,
    -0.23090249300003052,
    0.17610734701156616,
    -0.33448532223701477,
    -0.01719403825700283,
    -0.5553179383277893,
    -0.2767239809036255,
    -0.5561366081237793,
    -0.08547887951135635,
    0.13882502913475037,
    0.3474807143211365,
    0.4590737521648407,
    -0.14843913912773132,
    0.39384305477142334,
    -0.08534593135118484,
    -0.01026185229420662,
    0.23120488226413727,
    0.18327820301055908,
    0.24484306573867798,
    -0.17054015398025513,
    -0.03851364180445671,
    0.23073561489582062,
    -0.003950655460357666,
    0.014295939356088638,
    0.20093658566474915,
    0.31966713070869446,
    0.5458610653877258,
    -0.16919992864131927,
    -0.04218471050262451,
    -0.326958566904068,
    -0.38657236099243164,
    -0.18662288784980774,
    0.5816627144813538,
    -0.06113113462924957,
    -0.27536436915397644,
    0.27538156509399414,
    0.017201587557792664,
    0.3405604064464569,
    -0.513244092464447,
    0.3434593975543976,
    -0.5581334829330444,
    0.33396321535110474,
    -0.47166380286216736,
    0.2761699855327606,
    -0.10682584345340729,
    0.1433386206626892,
    0.527672529220581,
    0.20258204638957977,
    0.03596622869372368,
    0.2698138952255249,
    0.23160642385482788,
    -0.25965362787246704,
    -0.16222327947616577,
    -0.21663546562194824,
    -0.012845292687416077,
    0.13349254429340363,
    0.29629626870155334,
    0.01539093442261219,
    -0.015384765341877937,
    -0.2916506230831146,
    -0.05512615665793419,
    -0.3370289206504822,
    -0.06509958952665329,
    -0.19055384397506714,
    -0.12901395559310913,
    -0.029568778350949287,
    0.09933248162269592,
    0.19965331256389618,
    -0.08172080665826797,
    -0.4356915056705475,
    -0.48613160848617554,
    -0.05599459633231163,
    -0.22870254516601562,
    -0.24515070021152496,
    -0.1655881404876709,
    -0.45532453060150146,
    -0.13017819821834564,
    -0.1163177490234375,
    -0.20278531312942505,
    0.12183140218257904,
    0.15735071897506714,
    0.31192952394485474,
    0.6003413796424866,
    -0.16229240596294403,
    0.4107511043548584,
    -0.17133498191833496,
    -0.4438570737838745,
    -0.13358762860298157,
    0.16060805320739746,
    0.016250841319561005,
    0.004633689299225807,
    -0.0009835069067776203,
    0.0770757645368576,
    -0.5164621472358704,
    -0.2723758816719055,
    -0.35769352316856384,
    -0.009371048770844936,
    0.08567501604557037,
    0.45395633578300476,
    -0.018107512965798378,
    -0.5487083196640015,
    -0.17641381919384003,
    0.23114930093288422,
    0.039185669273138046,
    0.11175128072500229,
    -0.09822078794240952,
    0.031710028648376465,
    0.6688704490661621,
    -0.08064703643321991,
    0.23385947942733765,
    -0.49876806139945984,
    -0.1481647789478302,
    -0.1651521474123001,
    0.1581958830356598,
    0.3907588720321655,
    0.19771340489387512,
    0.13824328780174255,
    -0.10861290991306305,
    0.37062060832977295,
    -0.32603806257247925,
    0.652683436870575,
    0.3627920150756836,
    0.07582543790340424,
    -0.09147480130195618,
    0.043183207511901855,
    0.22038915753364563,
    -0.1939820945262909,
    0.022341959178447723,
    0.5047318935394287,
    -0.259931743144989,
    0.18978877365589142,
    0.19424182176589966,
    0.29646649956703186,
    -0.10196372866630554,
    0.22203649580478668,
    -0.5911935567855835,
    0.2748180627822876,
    0.2933439612388611,
    0.13591046631336212,
    -0.18686443567276,
    0.05299588292837143,
    -0.46956178545951843,
    0.1731799691915512,
    0.23355211317539215,
    -0.12852972745895386,
    0.0305658970028162,
    0.01566079817712307,
    -0.1997469812631607,
    -0.478629469871521,
    -0.010015438310801983,
    0.0829777866601944,
    -0.12942516803741455,
    0.25652238726615906,
    -0.5318357944488525,
    0.33982107043266296,
    0.41761672496795654,
    0.36571988463401794,
    0.4389635920524597,
    0.2363681048154831,
    -0.35565608739852905,
    -0.024740615859627724,
    0.03209609538316727,
    -0.22956980764865875,
    -0.11218611150979996,
    0.1492803692817688,
    -0.009255750104784966,
    0.21540944278240204,
    0.08700158447027206,
    -0.32436835765838623,
    0.11313005536794662,
    0.32171618938446045,
    -0.22453978657722473,
    -0.11332181841135025,
    -0.33852827548980713,
    -0.22908449172973633,
    -0.06537609547376633,
    0.42628511786460876,
    0.14143924415111542,
    -0.17935670912265778,
    -0.09369131922721863,
    -0.389884352684021,
    -0.13897141814231873,
    -0.13815243542194366,
    0.1320265233516693,
    0.0790148675441742,
    0.37558579444885254,
    -0.13394588232040405,
    -0.18961599469184875,
    -0.27387189865112305,
    -0.32254835963249207,
    0.2640625834465027,
    -0.2496419996023178,
    -0.22936351597309113,
    0.2660328149795532,
    0.03733725845813751,
    -0.13335749506950378,
    0.6186579465866089,
    0.10268396884202957,
    0.06378074735403061,
    0.1466071456670761,
    -0.309270441532135,
    -0.2465892881155014,
    -0.004508619662374258,
    0.08941607922315598,
    -0.018520325422286987,
    0.11097671836614609,
    0.3348693549633026,
    0.10179654508829117,
    -0.3345291316509247,
    -0.03973673656582832,
    0.06459066271781921,
    0.10482361167669296,
    0.2873627543449402,
    -0.16425643861293793,
    0.3101359009742737,
    -0.2142046093940735,
    -0.11375072598457336,
    0.44356849789619446,
    -0.21818485856056213,
    0.3203272819519043,
    -0.3074287474155426,
    0.20901866257190704,
    -0.02112933248281479,
    -0.2625077962875366,
    -0.0888354480266571,
    0.11917126178741455,
    -0.24305285513401031,
    0.04227721691131592,
    -0.15884175896644592,
    -0.3789592981338501,
    0.32920658588409424,
    -0.3736388385295868,
    0.011763619258999825
  ]
  },
  "filter": {
    "term": {
      "byline.keyword": "Melissa Alvarez"
    }
  },
  "_source": ["body_content_window", "url"]
}
